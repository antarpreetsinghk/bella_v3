name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  build-and-smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Create a minimal env just for CI. No real secrets used.
      - name: Create CI env file
        run: |
          cat > .env.ci << 'EOF'
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=bella
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          DATABASE_URL=postgresql+psycopg2://postgres:postgres@db:5432/bella

          # dummy placeholders for code paths that read these
          OPENAI_API_KEY=dummy
          TWILIO_ACCOUNT_SID=dummy
          TWILIO_AUTH_TOKEN=dummy
          TWILIO_PHONE_NUMBER=+10000000000

          ENV=ci
          EOF

      - name: Build & start services
        run: docker compose --env-file .env.ci up -d --build

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8000/ >/dev/null; then
              echo "API is up!"
              exit 0
            fi
            echo "[$i/30] Waiting for API..."
            sleep 5
          done
          echo "API did not become ready in time."
          docker compose logs --no-color api
          exit 1

      - name: Smoke test root endpoint
        run: curl -v http://localhost:8000/

      - name: Teardown
        if: always()
        run: docker compose --env-file .env.ci down -v

name: Deploy Bella V3 Cost-Optimized

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ubuntu
  SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
  AWS_REGION: ca-central-1

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run security checks
      run: |
        bandit -r app/ -f json -o bandit-report.json || true
        safety check --json > safety-report.json || true

    - name: Run tests
      env:
        DATABASE_URL: "postgresql+asyncpg://bella_user:test_password@localhost:5432/bella_test_db"
        POSTGRES_PASSWORD: "test_password"
        BELLA_API_KEY: "test_key"
        OPENAI_API_KEY: "test_key"
        TWILIO_ACCOUNT_SID: "test_sid"
        TWILIO_AUTH_TOKEN: "test_token"
        TWILIO_PHONE_NUMBER: "+15551234567"
        GOOGLE_CALENDAR_ENABLED: "false"
        APP_ENV: "testing"
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          bandit-report.json
          safety-report.json
          coverage.xml

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/bella-key.pem
        chmod 600 ~/.ssh/bella-key.pem
        ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        # Stop containers first to release file locks
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
          "cd ~/bella_v3 && docker compose -f docker-compose.cost-optimized.yml down || true"

        # Copy project files to EC2
        rsync -avz --delete \
          --exclude='.git/' \
          --exclude='node_modules/' \
          --exclude='*.log' \
          --exclude='.env.local' \
          --exclude='data/' \
          -e "ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no" \
          ./ ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/bella_v3/

        # Build Docker image on EC2 with timeout handling
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          -o ServerAliveInterval=60 -o ServerAliveCountMax=10 \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          cd ~/bella_v3

          # Clean up old images to save space and speed up build
          docker system prune -f --volumes || true
          docker builder prune -af || true

          # Remove any existing bella-v3 images to force complete rebuild
          docker rmi bella-v3:cost-optimized || true
          docker rmi $(docker images -q bella-v3) || true

          # Build with progress output and no cache for faster, more reliable builds
          echo "ðŸ”¨ Building Docker image..."
          timeout 600 docker build -f Dockerfile.cost-optimized \
            --progress=plain \
            --no-cache \
            -t bella-v3:cost-optimized . || {
            echo "âŒ Docker build timed out or failed"
            exit 1
          }

          echo "âœ… Docker build completed successfully"
        EOF

        # Start containers on EC2
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          -o ServerAliveInterval=60 -o ServerAliveCountMax=5 \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
          "cd ~/bella_v3 && \
           export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}' && \
           export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' && \
           echo 'ðŸš€ Starting containers...' && \
           docker compose -f docker-compose.cost-optimized.yml up -d --force-recreate && \
           echo 'â³ Waiting for services to start...' && \
           sleep 30"

        # Health check on EC2
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          -o ServerAliveInterval=60 -o ServerAliveCountMax=5 \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
          "cd ~/bella_v3 && \
           echo 'ðŸ©º Running health check...' && \
           for i in {1..12}; do \
             if curl -f http://localhost:8000/healthz; then \
               echo 'âœ… Health check passed' && exit 0; \
             fi; \
             echo 'Attempt '\$i'/12 failed, waiting 10s...' && sleep 10; \
           done && \
           echo 'âŒ Health check failed after 2 minutes' && \
           docker compose -f docker-compose.cost-optimized.yml logs app --tail=20 && \
           exit 1"

        echo "âœ… Deployment completed successfully!"

    - name: Verify deployment
      run: |
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          cd ~/bella_v3

          echo "ðŸ” Container Status:"
          docker compose -f docker-compose.cost-optimized.yml ps

          echo "ðŸ©º Health Checks:"
          curl -s http://localhost:8000/healthz | jq '.'
          curl -s http://localhost:8000/readyz | jq '.'

          echo "ðŸ“Š Resource Usage:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
        EOF

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment to production successful!"
          echo "ðŸŒ Application URL: http://${{ env.EC2_HOST }}:8000"
          echo "ðŸ©º Health Check: http://${{ env.EC2_HOST }}:8000/healthz"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi

  cleanup:
    needs: [test, build-and-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Setup SSH key for cleanup
      if: needs.build-and-deploy.result == 'success'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/bella-key.pem
        chmod 600 ~/.ssh/bella-key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Cleanup old Docker images
      if: needs.build-and-deploy.result == 'success'
      run: |
        ssh -i ~/.ssh/bella-key.pem -o StrictHostKeyChecking=no \
          ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          # Remove old Docker images to save space
          docker image prune -f
          docker volume prune -f

          echo "ðŸ§¹ Cleanup completed"
        EOF
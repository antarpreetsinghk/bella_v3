name: Security Scan

on:
  schedule:
    # Run security scans daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
  pull_request:
    paths:
      - 'requirements.txt'
      - '**/*.py'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-security-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Security tools
          pip install safety bandit semgrep

      - name: Run Safety (dependency vulnerability scan)
        run: |
          echo "ğŸ” Scanning for known vulnerabilities in dependencies..."
          safety check --json --output safety-report.json
          safety check --short-report

      - name: Run Bandit (static security analysis)
        run: |
          echo "ğŸ” Running static security analysis..."
          bandit -r app/ -f json -o bandit-report.json
          bandit -r app/ -ll

      - name: Run Semgrep (SAST)
        run: |
          echo "ğŸ” Running semantic security analysis..."
          python -m semgrep --config=auto app/ --json --output=semgrep-report.json || true
          python -m semgrep --config=auto app/ --text || true

      - name: Check for secrets
        run: |
          echo "ğŸ” Checking for exposed secrets..."
          # Simple regex patterns for common secrets
          if grep -r -E "(password|secret|key|token).*=" app/ --include="*.py" | grep -v "settings.py" | grep -v "config.py"; then
            echo "âš ï¸ Potential secrets found in code"
          else
            echo "âœ… No obvious secrets found"
          fi

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            safety-report.json
            bandit-report.json
            semgrep-report.json
          retention-days: 30

      - name: Security summary
        run: |
          echo "ğŸ“Š Security Scan Summary"
          echo "======================="
          echo "âœ… Dependency vulnerability scan completed"
          echo "âœ… Static security analysis completed"
          echo "âœ… Semantic security analysis completed"
          echo "âœ… Secret detection completed"
          echo ""
          echo "ğŸ“ Review the uploaded artifacts for detailed reports"